<div class="with-sidebar">
  <header>
    <app-admin-navbar></app-admin-navbar>
  </header>

  <div class="main">
  <!-- Título -->
  <section>
    <div class="container">
      <div class="row">
        <div class="col">
          <h1 class="tit-movimientos">
            <i class="bi bi-arrow-left-right me-2"></i>
            <span>Movimientos</span>
          </h1>
        </div>
      </div>
    </div>
  </section>
  <br>
  <!-- Botones Principales y Offcanvas -->
  <section>
    <div class="container unicion fixed-bottom">
      <div class="body1 d-flex justify-content-center">
        <button id="button1" class="btn btn-primary nueva-venta bg-green" data-bs-toggle="offcanvas" data-bs-target="#venta-libre">
          <img class="image-etiqueta me-3" src="../../assets/img/Logos Admin/venta.png" alt="">
          Nueva Venta
        </button>
      </div>
      <div class="body2 d-flex justify-content-center">
        <button id="button3" class="btn btn-primary nuevo-gasto" data-bs-toggle="offcanvas" data-bs-target="#gasto" >
          <img class="image-etiqueta me-3" src="../../assets/img/Logos Admin/gasto.png" alt="">
          Nuevo Gasto
        </button>
        <!-- Offcanvas Venta Libre -->
        <div class="offcanvas offcanvas-start" data-bs-backdrop="static" tabindex="-1" id="venta-libre" aria-labelledby="staticBackdropLabel" style="--bs-offcanvas-width: 600px;">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="staticBackdropLabel">Crear Venta Libre</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body" style="padding-left: 8px; padding-right: 8px;">
            <app-add-venta-libre></app-add-venta-libre>
          </div>
        </div>
        <!-- Offcanvas Gasto -->
        <div class="offcanvas offcanvas-start" data-bs-backdrop="static" tabindex="-1" id="gasto" aria-labelledby="staticBackdropLabel" style="--bs-offcanvas-width: 440px;">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="staticBackdropLabel">Crear Gasto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <app-add-gasto></app-add-gasto>
          </div>
        </div>
      </div>
    </div>
  </section>

  <br>
  <section>
    <div class="container unicion ">
      <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-4 d-flex justify-content-center ">
          <div class="balance balances">
            <img class="img-balance " width="100px" src="../../assets/img/Logos Admin/Balance.png" alt="">
            <div class="balance-precio ">
              <h4>Balance<span *ngIf="showRangeTag"> (en rango)</span></h4>
              <h5><span [ngClass]="{ 'text-success': balance > 0, 'text-danger': balance < 0 }">{{ formatCop(balance) }}</span></h5>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 d-flex justify-content-center ">
          <div class="balance balances">
            <img class="img-balance " width="100px" src="../../assets/img/Logos Admin/ventas.png" alt="">
            <div class="balance-precio">
              <h4>Ventas Totales<span *ngIf="showRangeTag"> (en rango)</span></h4>
              <h5> <span class="precio_letra">{{ formatCop(ventasTotales) }}</span></h5>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-12 col-lg-4 d-flex justify-content-center ">
          <div class="balance gastos">
            <img class="img-balance" width="105px" src="../../assets/img/Logos Admin/gastos.png" alt="">
            <div class="balance-precio">
              <h4>Gastos Totales<span *ngIf="showRangeTag"> (en rango)</span></h4>
              <h5> <span class="precio_letra_rojo">{{ formatCop(gastosTotales) }}</span></h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <br>
  <!-- Filtros, Calendario, Rango, Buscador, Reporte -->
  <section>
    <div class="container d-flex justify-content-center">
      <div class="row toolbar-equal">
        <!-- Buscador -->
        <div class="col-sm-12 col-md-6 col-lg-3 buscador-reportes">
          <form class="busc" role="search" (submit)="$event.preventDefault()">
            <div class="input-group busca">
              <button class="btn btn-primary boton_buscador" type="button">
                <img width="28px" src="../../assets/img/Logos Admin/Buscador.png" alt="">
              </button>
              <input class="form-control input-buscador" type="search" placeholder="Buscar" aria-label="Buscar" [(ngModel)]="searchTerm" name="search" (ngModelChange)="onSearchChange()">
            </div>
          </form>
        </div>
        <!-- Filtro -->
        <div class="col-sm-6 col-md-3 col-lg-2 d-flex justify-content-center text-center ">
          <button  id="" class="btn btn-primary filtro bg-white" data-bs-toggle="modal" data-bs-target="#filtroModal">
            <img width="25px" class="me-0.5" src="../../assets/img/Logos Admin/filtro.png" alt=""><span class="letrafiltro">Filtros</span>
          </button>
          <div class="modal fade" id="filtroModal" tabindex="-1" aria-labelledby="filtroModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="filtroModalLabel">Filtros avanzados</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <app-filter (filtersChange)="applyAdvancedFilters($event)"></app-filter>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Rango global Desde / Hasta -->
        <div class="col-sm-12 col-md-6 col-lg-3 d-flex align-items-center date-range-col">
          <div class="w-100 d-flex gap-2 date-range-wrapper">
            <div class="flex-grow-1" (click)="dateFromPicker.showPicker()">
              <input
                #dateFromPicker
                type="date"
                class="form-control date-range-input w-100"
                placeholder="Desde"
                [(ngModel)]="dateFromInput"
                (change)="setRange('personalizado', true)"
              >
            </div>
            <div class="flex-grow-1" (click)="dateToPicker.showPicker()">
              <input
                #dateToPicker
                type="date"
                class="form-control date-range-input w-100"
                placeholder="Hasta"
                [(ngModel)]="dateToInput"
                (change)="setRange('personalizado', true)"
              >
            </div>
          </div>
        </div>
        <!-- Rango -->
        <div class="col-sm-6 col-md-3 col-lg-2 dropdown range-dropdown-col">
          <button id="button" class="btn btn-primary dropdown-toggle bg-white range range-dropdown-btn" data-bs-toggle="dropdown">
            <img width="20" height="20" class="me-1" src="../../assets/img/Logos Admin/filtro.png" alt="">{{ rangeLabel }}
          </button>
          <div class="dropdown-menu">
            <a class="dropdown-item flexible2" href="#" (click)="clearRange(); $event.preventDefault()">
              <div class="contenido-botones2">
                <h6>Sin Filtro</h6>
              </div>
            </a>
            <a class="dropdown-item " href="#" (click)="setRange('diario'); $event.preventDefault()">
              <div class="contenido-botones2">
                <h6>Diario</h6>
              </div>
            </a>
            <a class="dropdown-item flexible2" href="#" (click)="setRange('semanal'); $event.preventDefault()">
              <div class="contenido-botones2">
                <h6>Semanal</h6>
              </div>
            </a>
            <a class="dropdown-item flexible2" href="#" (click)="setRange('mensual'); $event.preventDefault()">
              <div class="contenido-botones2">
                <h6>Mensual</h6>
              </div>
            </a>
          </div>
        </div>
        

      </div>
    </div>
  </section>
  <br>
  <!-- Selecciones de Ventas -->
  <section>
    <div class="container unicion">
      <div class="row">
        <div class="col">
          <div class="d-flex align-items-center justify-content-center">
            <button class="seleccion" (click)="selectTab('ingresos')" [class.active]="selectedTab==='ingresos'">Ingresos<span *ngIf="showRangeTag" class="text-primary small ms-1">(en rango)</span></button>
          </div>
        </div>
        <div class="col">
          <div class="d-flex align-items-center justify-content-center">
            <button class="seleccion" (click)="selectTab('egresos')" [class.active]="selectedTab==='egresos'">Egresos<span *ngIf="showRangeTag" class="text-primary small ms-1">(en rango)</span></button>
          </div>
        </div>
        <div class="col">
          <div class="d-flex align-items-center justify-content-center">
            <button class="seleccion" (click)="selectTab('por_cobrar')" [class.active]="selectedTab==='por_cobrar'">Por Cobrar<span *ngIf="showRangeTag" class="text-primary small ms-1">(en rango)</span></button>
          </div>
        </div>
        <div class="col">
          <div class="d-flex align-items-center justify-content-center">
            <button class="seleccion" (click)="selectTab('por_pagar')" [class.active]="selectedTab==='por_pagar'">Por Pagar<span *ngIf="showRangeTag" class="text-primary small ms-1">(en rango)</span></button>
          </div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col d-flex justify-content-end">
          <button
            type="button"
            class="btn chip-btn d-inline-flex align-items-center report-export-btn"
            (click)="exportCurrentTab()"
            [disabled]="
              (selectedTab==='ingresos' && ventasIngresos.length === 0) ||
              (selectedTab==='egresos' && gastosEgresos.length === 0) ||
              (selectedTab==='por_cobrar' && ventasPorCobrar.length === 0) ||
              (selectedTab==='por_pagar' && gastosPorPagar.length === 0)
            "
          >
            <img class="icon-quick" src="../../assets/img/Logos Admin/xls.png" alt="">
            <span>Reporte</span>
          </button>
        </div>
      </div>
    </div>
  </section><br>
  
  <!-- Tabla Ingresos -->
  <section *ngIf="selectedTab==='ingresos'">
    <div class="container">
      <div class="row">
        <table class="table table-hover align-middle shadow-sm rounded overflow-hidden">
          <thead class="table-light">
            <tr>
              <th>Nombre Productos</th>
              <th class="text-end">Valor</th>
              <th class="ocultar-en-movil">Medio de Pago</th>
              <th class="ocultar-en-movil">Fecha y Hora</th>
              <th class="ocultar-en-movil">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let v of ventasIngresos" class="table-row-click" (click)="abrirDialogoVenta(v)">
              <td data-label="Nombre Productos">
                <div class="producto-resumen d-flex gap-2 align-items-center">
                  <img src="../../assets/img/Logos Admin/ventas.png" alt="" class="img-responsive" width="36" height="36">
                  <div class="info-producto d-flex flex-column">
                    <span class="nom_produc fw-semibold text-truncate" style="max-width: 240px;">
                      {{ (v.tipo_venta || '') === 'libre' ? ('Venta Libre #' + (v.id || '')) : ('Venta #' + (v.id || '')) }}
                    </span>
                    <small class="text-muted">Por: {{ empleadoNombreById(getUsuarioIdFromVenta(v)) }} • Turno: {{ getTurnoIdFromVenta(v) || '—' }}</small>
                    <small class="text-muted d-md-none">{{ v.forma_pago || '-' }} • {{ v.fecha_hora | date:'dd/MM/yyyy | hh:mm a' }}</small>
                  </div>
                </div>
              </td>
              <td class="valo text-end" data-label="Valor">
                <span *ngIf="v.descuentoPorcentaje" class="badge text-bg-danger me-2">-{{ v.descuentoPorcentaje }}%</span>
                <span class="valor-derecha fw-bold text-success">{{ v.total | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
              </td>
              <td class="ocultar-en-movil" data-label="Medio de Pago">
                <span>{{ v.forma_pago || '-' }}</span>
                <br *ngIf="v.transaccionId">
                <small class="text-muted" *ngIf="v.transaccionId">ID: {{ v.transaccionId }}</small>
              </td>
              <td class="ocultar-en-movil" data-label="Fecha y Hora">{{ v.fecha_hora | date:'dd/MM/yyyy | hh:mm a' }}</td>
              <td class="ocultar-en-movil" data-label="Estado">
                <span class="status" [class.activo]="(v.estado||'').toLowerCase()==='pagada'" [class.text-muted]="(v.estado||'').toLowerCase()!=='pagada'">{{ v.estado || 'Pagada' }}</span>
              </td>
            </tr>
            <tr *ngIf="ventasIngresos.length === 0">
              <td colspan="5" class="text-center text-muted py-4">No hay Ventas Registradas</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Tabla Gastos -->
  <section *ngIf="selectedTab==='egresos'">
    <div class="container">
      <div class="row">
        <table class="table table-hover align-middle shadow-sm rounded overflow-hidden">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th class="ocultar-en-movil">Descripción</th>
              <th class="text-end">Monto</th>
              <th class="ocultar-en-movil">Medio de Pago</th>
              <th class="ocultar-en-movil">Fecha</th>
              <th class="ocultar-en-movil">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let g of gastosEgresos" class="table-row-click" (click)="abrirDialogoGasto(g)" style="cursor: pointer;">
              <td data-label="Nombre">
                <div class="producto-resumen d-flex gap-2 align-items-center">
                  <img src="../../assets/img/Logos Admin/gastos.png" alt="" class="img-responsive" width="36" height="36">
                  <div class="info-producto d-flex flex-column">
                    <span class="nom_produc fw-semibold text-truncate" style="max-width: 240px;">{{ g.nombre || ('Gasto #' + g.id) }}</span>
                    <small class="text-muted">Por: {{ empleadoNombreById(getUsuarioIdFromGasto(g)) }} • Turno: {{ getTurnoIdFromGasto(g) || '—' }}</small>
                    <small class="text-muted d-md-none">{{ g.forma_pago || '-' }} • {{ g.fecha | date:'dd/MM/yyyy' }}</small>
                  </div>
                </div>
              </td>
              <td class="ocultar-en-movil" data-label="Descripción">
                <span class="text-truncate" style="max-width: 260px; display: inline-block;">{{ g.descripcion || '-' }}</span>
              </td>
              <td class="valo text-end" data-label="Monto">
                <span class="valor-derecha fw-bold text-danger">{{ (g.monto || 0) | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
              </td>
              <td class="ocultar-en-movil" data-label="Medio de Pago">
                <span>{{ g.forma_pago || '-' }}</span>
                <br *ngIf="g.transaccionId">
                <small class="text-muted" *ngIf="g.transaccionId">ID: {{ g.transaccionId }}</small>
              </td>
              <td class="ocultar-en-movil" data-label="Fecha">{{ g.fecha | date:'dd/MM/yyyy' }}</td>
              <td class="ocultar-en-movil" data-label="Estado">
                <span
                  class="status"
                  [class.activo]="(g.estado||'').toLowerCase()==='confirmado'"
                  [ngClass]="{
                    'bg-primary-subtle text-primary': (g.estado||'').toLowerCase()==='pendiente',
                    'bg-danger-subtle text-danger': (g.estado||'').toLowerCase()==='anulado',
                    'text-muted': ['confirmado','pendiente','anulado'].indexOf((g.estado||'').toLowerCase()) === -1
                  }"
                >{{ g.estado }}</span>
              </td>
            </tr>
            <tr *ngIf="gastosEgresos.length === 0">
              <td colspan="6" class="text-center text-muted py-4">No hay Gastos Registrados</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Tabla Por Cobrar (Ventas pendientes) -->
  <section *ngIf="selectedTab==='por_cobrar'">
    <div class="container">
      <div class="row">
        <table class="table table-hover align-middle shadow-sm rounded overflow-hidden">
          <thead class="table-light">
            <tr>
              <th>Nombre Productos</th>
              <th class="text-end">Valor</th>
              <th class="ocultar-en-movil">Medio de Pago</th>
              <th class="ocultar-en-movil">Fecha y Hora</th>
              <th class="ocultar-en-movil">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let v of ventasPorCobrar" class="table-row-click" (click)="abrirDialogoVenta(v)">
              <td data-label="Nombre Productos">
                <div class="producto-resumen d-flex gap-2 align-items-center">
                  <img src="../../assets/img/Logos Admin/ventas.png" alt="" class="img-responsive" width="36" height="36">
                  <div class="info-producto d-flex flex-column">
                    <span class="nom_produc fw-semibold text-truncate" style="max-width: 240px;">
                      {{ (v.tipo_venta || '') === 'libre' ? ('Venta Libre #' + (v.id || '')) : ('Venta #' + (v.id || '')) }}
                    </span>
                    <small class="text-muted">Por: {{ empleadoNombreById(getUsuarioIdFromVenta(v)) }} • Turno: {{ getTurnoIdFromVenta(v) || '—' }}</small>
                    <small class="text-muted d-md-none">{{ v.forma_pago || '-' }} • {{ v.fecha_hora | date:'dd/MM/yyyy | hh:mm a' }}</small>
                  </div>
                </div>
              </td>
              <td class="valo text-end" data-label="Valor">
                <span *ngIf="v.descuentoPorcentaje" class="badge text-bg-danger me-2">-{{ v.descuentoPorcentaje }}%</span>
                <span class="valor-derecha fw-bold text-success">{{ v.total | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
              </td>
              <td class="ocultar-en-movil" data-label="Medio de Pago">{{ v.forma_pago || '-' }}</td>
              <td class="ocultar-en-movil" data-label="Fecha y Hora">{{ v.fecha_hora | date:'dd/MM/yyyy | hh:mm a' }}</td>
              <td class="ocultar-en-movil" data-label="Estado">
                <span class="status bg-primary-subtle text-primary">{{ v.estado || 'Pendiente' }}</span>
              </td>
            </tr>
            <tr *ngIf="ventasPorCobrar.length === 0">
              <td colspan="5" class="text-center text-muted py-4">No hay Ventas Pendientes por Cobrar</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Tabla Por Pagar (Gastos pendientes) -->
  <section *ngIf="selectedTab==='por_pagar'">
    <div class="container">
      <div class="row">
        <table class="table table-hover align-middle shadow-sm rounded overflow-hidden">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th class="ocultar-en-movil">Descripción</th>
              <th class="text-end">Monto</th>
              <th class="ocultar-en-movil">Medio de Pago</th>
              <th class="ocultar-en-movil">Fecha</th>
              <th class="ocultar-en-movil">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let g of gastosPorPagar" class="table-row-click" (click)="abrirDialogoGasto(g)" style="cursor: pointer;">
              <td data-label="Nombre">
                <div class="producto-resumen d-flex gap-2 align-items-center">
                  <img src="../../assets/img/Logos Admin/gastos.png" alt="" class="img-responsive" width="36" height="36">
                  <div class="info-producto d-flex flex-column">
                    <span class="nom_produc fw-semibold text-truncate" style="max-width: 240px;">{{ g.nombre || ('Gasto #' + g.id) }}</span>
                    <small class="text-muted">Por: {{ empleadoNombreById(getUsuarioIdFromGasto(g)) }} • Turno: {{ getTurnoIdFromGasto(g) || '—' }}</small>
                    <small class="text-muted d-md-none">{{ g.forma_pago || '-' }} • {{ g.fecha | date:'dd/MM/yyyy' }}</small>
                  </div>
                </div>
              </td>
              <td class="ocultar-en-movil" data-label="Descripción">
                <span class="text-truncate" style="max-width: 260px; display: inline-block;">{{ g.descripcion || '-' }}</span>
              </td>
              <td class="valo text-end" data-label="Monto">
                <span class="valor-derecha fw-bold text-danger">{{ (g.monto || 0) | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
              </td>
              <td class="ocultar-en-movil" data-label="Medio de Pago">{{ g.forma_pago || '-' }}</td>
              <td class="ocultar-en-movil" data-label="Fecha">{{ g.fecha | date:'dd/MM/yyyy' }}</td>
              <td class="ocultar-en-movil" data-label="Estado">
                <span class="status bg-primary-subtle text-primary">{{ g.estado || 'Pendiente' }}</span>
              </td>
            </tr>
            <tr *ngIf="gastosPorPagar.length === 0">
              <td colspan="6" class="text-center text-muted py-4">No hay Gastos Pendientes por Pagar</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>
<app-agente-ia></app-agente-ia>