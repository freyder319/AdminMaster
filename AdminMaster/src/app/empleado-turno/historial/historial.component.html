<section>
  <div class="container-fluid historial-container">
    <div class="row">
      <div class="col-12">
        <div class="turno-card">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="titulo mb-0">
              <i class="bi bi-activity me-2"></i>
              <span>Historial</span>
            </h2>
            <button type="button" class="btn-turno btn-sm" (click)="limpiarFiltros()">
              Limpiar filtros
            </button>
          </div>
          <div class="filtros-con-labels">
            <div class="campo-buscar">
              <label for="buscar-input" class="campo-label">Buscador</label>
              <div class="input-icon">
                <i class="bi bi-search" aria-hidden="true"></i>
                <input id="buscar-input" type="search" [(ngModel)]="q" placeholder="Buscar (módulo/acción/entidad)" class="form-control" aria-label="Buscar">
              </div>
            </div>
            <div class="campo-fecha">
              <label for="fecha-desde" class="campo-label">Desde</label>
              <input
                id="fecha-desde"
                type="date"
                [(ngModel)]="from"
                class="form-control clickable-date"
                aria-label="Desde"
                title="Desde (fecha)"
                (click)="openDatePicker($event)"
                (change)="validateDates()"
                readonly
              >
            </div>
            <div class="campo-fecha">
              <label for="fecha-hasta" class="campo-label">Hasta</label>
              <input
                id="fecha-hasta"
                type="date"
                [(ngModel)]="to"
                class="form-control clickable-date"
                aria-label="Hasta"
                title="Hasta (fecha)"
                [min]="from"
                (click)="openDatePicker($event)"
                (change)="validateDates()"
                readonly
              >
            </div>
            <small *ngIf="dateError" class="text-danger" style="width: 100%; margin-top: -8px; display: block;">
              La fecha 'Hasta' no puede ser anterior a la fecha 'Desde'
            </small>
          </div>
          <div *ngIf="cargando">Cargando...</div>
          <div *ngIf="!cargando && view.length === 0">
            <p>Sin Eventos por Ahora.</p>
          </div>
          <ul class="turno-lista" *ngIf="!cargando && view.length > 0">
            <li class="turno-item" *ngFor="let ev of view" (click)="abrirDetalle(ev)" role="button" tabindex="0">
              <i class="bi bi-activity item-icon" aria-hidden="true"></i>
              <div class="turno-item-info">
                <div class="turno-item-primario">
                  <strong>{{ ev.module }}</strong>
                  <span class="badge bg-secondary ms-2">{{ tAction(ev.action) }}</span>
                </div>
                <div class="turno-item-secundario text-muted">
                  <i class="bi bi-clock inline" aria-hidden="true"></i>
                  {{ ev.timestamp | date:'short' }} ·
                  <span *ngIf="ev.entity">{{ ev.entity }}</span>
                  <span *ngIf="ev.entityId">#{{ ev.entityId }}</span>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal-backdrop" [hidden]="!modalAbierto"></div>
<div class="modal-contenedor" [hidden]="!modalAbierto" role="dialog" aria-modal="true">
  <div class="modal-header">
    <h3 class="modal-title">
      <i class="bi bi-activity me-2"></i>
      <span>Detalle de evento</span>
    </h3>
    <button type="button" class="modal-cerrar" (click)="cerrarDetalle($event)">✕</button>
  </div>
  <div class="modal-body" *ngIf="seleccionado as evd">
    <div class="datos-grid">
      <div class="kv" *ngIf="evd.entity"><span class="k">Entidad</span><span class="v">{{ evd.entity }}</span></div>
      <div class="kv" *ngIf="displayEntityId(evd) as id">
        <span class="k">{{ isProducto(evd) ? 'Código producto' : 'ID' }}</span>
        <span class="v">{{ id }}</span>
      </div>
      <div class="kv"><span class="k">Acción</span><span class="v">{{ tAction(evd.action) }}</span></div>
      <div class="kv"><span class="k">Fecha</span><span class="v">{{ evd.timestamp | date:'short' }}</span></div>
      <div class="kv"><span class="k">Usuario</span><span class="v">{{ displayUsuario(evd) }}</span></div>
      <div class="kv"><span class="k">Rol</span><span class="v">{{ evd.actorRol || '—' }}</span></div>
    </div>
  </div>
  <div class="modal-footer" (click)="$event.stopPropagation()">
    <button type="button" class="btn-turno" (click)="cerrarDetalle($event)">Cerrar</button>
  </div>
</div>
<app-agente-ia></app-agente-ia>