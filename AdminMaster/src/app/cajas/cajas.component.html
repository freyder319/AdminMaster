<div class="with-sidebar">
  <header>
    <app-admin-navbar></app-admin-navbar>
  </header>

  <main>
  <!-- Vista principal (solo cuando NO estoy en agregar NI modificar en móvil) -->
  <div *ngIf="!mostrarAddCaja && !mostrarModificarCaja">

    <!-- Título -->
    <section>
      <div class="container text-center">
        <div class="row">
          <div class="col">
            <h1 class="tit-cajas">
              <i class="bi bi-safe2-fill me-2"></i>
              <span>Cajas</span>
            </h1>
          </div>
        </div>
      </div>
    </section>
    <br>

    <!-- Búsqueda y Agregar -->
    <section>
      <div class="container buscar-agg">
        <div class="row">
          <!-- Buscar -->
          <div class="col-sm-12 col-md-6 col-lg-6">
            <div class="search">
              <div class="input-group">
                <input type="text"  class="form-control" placeholder="Buscar Caja..." id="search-input" (input)="onSearch($any($event.target).value)">
              </div>
            </div>
          </div>

          <!-- Agregar Caja -->
          <div class="col-sm-12 col-md-6 col-lg-6">
            <div class="agg-caja">

              <!-- Escritorio (≥768px) → abre offcanvas -->
              <button class="btn agregar d-none d-md-inline-block" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAddCaja" aria-controls="offcanvasAddCaja">
                <span class="texto">Agregar Caja</span>
                <img width="80px" src="assets/img/icono_cajas/Proveedores__5_-removebg-preview (1).png" alt="">
              </button>

              <!-- Móvil (<768px) → cambia de interfaz -->
              <button class="btn agregar d-md-none" type="button" (click)="mostrarAddCaja = true">
                <span class="texto">Agregar Caja</span>
                <img width="80px" src="assets/img/icono_cajas/Proveedores__5_-removebg-preview (1).png" alt="">
              </button>

            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabla Información -->
    <section>
      <div class="container">
        <table class="table table-bordered">
          <thead class="table-secondary">
            <tr>
              <th>Nombre</th>
              <th>Código de Caja</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody *ngIf="(filteredCajas$ | async) as list">
            <!-- Cajas -->
            <tr *ngFor="let caja of list" [ngClass]="{'fila-inactiva': (caja.estado || '').toLowerCase() === 'inactiva'}">
              <td data-label="Nombre">
                <!-- Móvil (<768px) → perfil clickeable -->
                <div class="perfil clickable d-md-none" (click)="mostrarInterfazReponsive(caja.id)">
                  <img src="assets/img/icons-navbar/Cajas.png" alt="Caja 1">
                  <div class="info">
                    <p class="nombre"><strong>{{ caja.nombre }}</strong></p>
                    <p class="codigo">{{ caja.codigoCaja }}</p>
                  </div>
                </div>

                <!-- Escritorio (≥768px) -->
                <div class="perfil d-none d-md-flex">
                  <img src="assets/img/icons-navbar/Cajas.png" alt="Caja 1" width="50px" height="50px" style="margin-top: -10px;">
                  <div class="info">
                    <p class="nombre" style="margin-left: 10px;"><strong>{{ caja.nombre }}</strong></p>
                  </div>
                </div>
              </td>

              <td data-label="Código de Caja">{{ caja.codigoCaja }}</td>
              <td data-label="Estado de Caja">
                <span class="status" [ngClass]="caja.estado.toLowerCase()">
                  {{ caja.estado }}
                </span>
              </td>
              <td data-label="Acciones" class="acciones">
                <!-- Texto (≥1200px) -->
                <div class="d-none d-xl-flex gap-2">
                  <ng-container *ngIf="(caja.estado || '').toLowerCase() === 'inactiva'; else accionesActiva">
                    <button class="btn modificar d-none d-md-inline-block" type="button" (click)="abrirModificarCaja(caja)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasModifyCaja" aria-controls="offcanvasModifyCaja">
                      <i class="bi bi-pencil-square"></i>
                      <span class="texto">Modificar</span>
                    </button>
                    <button (click)="habilitarCaja(caja)" class="btn habilitar">
                      <i class="bi bi-check2-circle"></i>
                      Habilitar
                    </button>
                  </ng-container>
                  <ng-template #accionesActiva>
                    <button class="btn modificar d-none d-md-inline-block" type="button" (click)="abrirModificarCaja(caja)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasModifyCaja" aria-controls="offcanvasModifyCaja">
                      <i class="bi bi-pencil-square"></i>
                      <span class="texto">Modificar</span>
                    </button>
                    <button *ngIf="!isCajaEnUso(caja)" (click)="eliminarCaja(caja.id)" class="btn elimi">
                      <i class="bi bi-trash"></i>
                      Eliminar
                    </button>
                    <button *ngIf="isCajaEnUso(caja)" (click)="inhabilitarCaja(caja)" class="btn inhabilitar">
                      <i class="bi bi-slash-circle"></i>
                      Inhabilitar
                    </button>
                  </ng-template>
                </div>

                <!-- Íconos (768px – 1200px) -->
                <div class="d-none d-md-flex d-xl-none gap-2">
                  <ng-container *ngIf="(caja.estado || '').toLowerCase() === 'inactiva'; else accionesActivaIcon">
                    <button class="btn modificar icon-btn d-none d-md-inline-block" title="Modificar" type="button" (click)="abrirModificarCaja(caja)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasModifyCaja" aria-controls="offcanvasModifyCaja">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button (click)="habilitarCaja(caja)" class="btn habilitar-icon icon-btn" title="Habilitar">
                      <i class="bi bi-check2-circle"></i>
                    </button>
                  </ng-container>
                  <ng-template #accionesActivaIcon>
                    <button class="btn modificar icon-btn d-none d-md-inline-block" title="Modificar" type="button" (click)="abrirModificarCaja(caja)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasModifyCaja" aria-controls="offcanvasModifyCaja">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button *ngIf="!isCajaEnUso(caja)" (click)="eliminarCaja(caja.id)" class="btn eliminar-icon icon-btn" title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                    <button *ngIf="isCajaEnUso(caja)" (click)="inhabilitarCaja(caja)" class="btn inhabilitar-icon icon-btn" title="Inhabilitar">
                      <i class="bi bi-slash-circle"></i>
                    </button>
                  </ng-template>
                </div>
              </td>
            </tr>
            <tr *ngIf="list.length === 0">
              <td colspan="7" class="text-center text-muted py-3">
                {{ lastSearchTerm ? ('No se encontró ninguna caja para "' + lastSearchTerm + '".') : 'No hay Cajas Registradas' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Vista de Agregar Caja en móvil -->
  <div *ngIf="mostrarAddCaja" class="d-md-none">
    <div class="container mt-4 p-3 shadow rounded bg-light">
      <app-add_cajas (cajaAgregada)="onCajaAgregada($event)"></app-add_cajas>
      <div class="mt-3">
        <button class="btn btn-volver" type="button" (click)="mostrarAddCaja = false">
          <i class="bi bi-arrow-left-short"></i> Volver
        </button>
      </div>
    </div>
  </div>

  <!-- Vista de Modificar Caja en móvil -->
  <div *ngIf="mostrarModificarCaja" class="d-md-none">
    <div class="container mt-4 p-3 shadow rounded bg-light">
      <app-modify-caja *ngIf="mostrarModificarCaja" [caja]="cajaSeleccionada" (cajaModificada)="onCajaModificada($event)"></app-modify-caja>
      <div class="mt-3 space">
        <button class="btn btn-volver" type="button" (click)="mostrarModificarCaja = false">
          <i class="bi bi-arrow-left-short"></i> Volver
        </button>
        <ng-container *ngIf="cajaSeleccionada && (cajaSeleccionada.estado || '').toLowerCase() === 'inactiva'; else accionesMovilActiva">
          <button (click)="habilitarCaja(cajaSeleccionada)" class="btn habilitar">
            <i class="bi bi-check2-circle"></i> Habilitar
          </button>
        </ng-container>
        <ng-template #accionesMovilActiva>
          <button *ngIf="cajaSeleccionada && !isCajaEnUso(cajaSeleccionada)" (click)="eliminarCaja(cajaSeleccionada.id)" class="btn eliminar">
            <i class="bi bi-trash-fill"></i> Eliminar
          </button>
          <button *ngIf="cajaSeleccionada && isCajaEnUso(cajaSeleccionada)" (click)="inhabilitarCaja(cajaSeleccionada)" class="btn inhabilitar">
            <i class="bi bi-slash-circle"></i> Inhabilitar
          </button>
        </ng-template>
      </div>
    </div>
  </div>
  </main>
</div>
<app-agente-ia></app-agente-ia>

<!-- Offcanvas (solo para pantallas grandes) Agregar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasAddCaja" aria-labelledby="offcanvasAddCajaLabel" (shown.bs.offcanvas)="focusFirstInput('offcanvasAddCaja')">
  <div class="offcanvas-header">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body">
    <app-add_cajas (cerrarOffcanvas)="cerrarOffcanvas()" (cajaAgregada)="onCajaAgregada($event)"></app-add_cajas>
  </div>
</div>

<!-- Offcanvas (solo para pantallas grandes) Modificar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasModifyCaja" aria-labelledby="offcanvasModifyCajaLabel">
  <div class="offcanvas-header">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body">
    <app-modify-caja [caja]="cajaSeleccionada" (cajaModificada)="onCajaModificada($event)"></app-modify-caja>
  </div>
</div>
