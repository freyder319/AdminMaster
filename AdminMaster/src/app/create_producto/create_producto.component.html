<!-- Formulario Registro -->
<div class="container form">
  <div class="container subir-img text-center mb-4">
    <div class="image-upload-box" (click)="abrirSelectorImagen()">
      <img
        id="preview"
        [src]="previewUrl || 'https://static.vecteezy.com/system/resources/previews/022/059/000/non_2x/no-image-available-icon-vector.jpg'"
        alt="Vista previa"
        class="img-fluid rounded mb-2"
      />
      <div class="overlay-text">
        <i class="bi bi-cloud-arrow-up fs-3"></i>
        <p class="m-0">Haz clic para subir imagen</p>
      </div>
    </div>
    <input
    title="imagen"
      #imagenInput
      type="file"
      accept="image/*"
      id="imagenInput"
      class="d-none"
      (change)="mostrarPreview($event)"
    />
  </div>

  <div class="formulario">
    <form (ngSubmit)="onSubmit()" #formulario="ngForm" novalidate>
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre del Producto</label>
        <input
          type="text"
          class="form-control"
          id="nombre"
          name="nombreProducto"
          required
          maxlength="80"
          [(ngModel)]="producto.nombreProducto"
          #nombreProducto="ngModel"
          #nombreInput
          (keydown.enter)="onEnterNombre($event)"
        />
        <div class="invalid-feedback d-block" *ngIf="nombreProducto.invalid && (nombreProducto.dirty || nombreProducto.touched)">
          El nombre es obligatorio.
        </div>
        <div class="invalid-feedback d-block" *ngIf="(producto.nombreProducto?.length || 0) > 80">
          El nombre no puede sobrepasar 80 caracteres.
        </div>
      </div>

      <div class="mb-3">
        <label for="codigo" class="form-label">Código de Producto</label>
        <input
          type="text"
          class="form-control"
          id="codigo"
          name="codigoProducto"
          required
          [(ngModel)]="producto.codigoProducto"
          pattern="^[A-Za-z0-9]+$"
          title="Solo letras y números (sin signos)"
          (ngModelChange)="onCodigoInput($event)"
          (blur)="validarCodigo()"
          #codigoProducto="ngModel"
          #codigoInput
          (keydown.enter)="onEnterCodigo($event)"
          [ngClass]="{ 'is-invalid': (codigoProducto.invalid && (codigoProducto.dirty || codigoProducto.touched)) || codigoExistente }"
        />
        <div class="invalid-feedback d-block" *ngIf="codigoProducto.invalid && (codigoProducto.dirty || codigoProducto.touched)">
          El código es obligatorio y solo puede contener letras y números.
        </div>
        <div class="invalid-feedback d-block" *ngIf="!codigoProducto.invalid && codigoExistente">
          Este código ya existe. Ingrese uno diferente.
        </div>
      </div>

      <div class="mb-3">
        <label for="stock" class="form-label">Productos Disponibles (Stock)</label>
        <input
          type="number"
          class="form-control"
          [ngClass]="{ 'is-invalid': stockProducto.invalid && (stockProducto.dirty || stockProducto.touched) }"
          id="stock"
          name="stockProducto"
          required
          min="0"
          max="500"
          placeholder="0"
          [ngModel]="producto.stockProducto || null"
          (ngModelChange)="producto.stockProducto = $event"
          #stockProducto="ngModel"
          #stockInput
          (keydown.enter)="onEnterStock($event)"
        />
        <div class="invalid-feedback d-block" *ngIf="stockProducto.invalid && (stockProducto.dirty || stockProducto.touched)">
          El stock es obligatorio y no puede ser negativo.
        </div>
        <div class="invalid-feedback d-block" *ngIf="stockProducto.errors?.['max']">
          El stock máximo permitido es de 500 unidades.
        </div>
      </div>

      <div class="mb-3">
        <label for="precioUnitario" class="form-label">Precio Unitario</label>
        <input
          type="number"
          class="form-control"
          id="precioUnitario"
          name="precioUnitario"
          required
          min="0"
          [(ngModel)]="producto.precioUnitario"
          #precioUnitario="ngModel"
          #precioUnitarioInput
          (keydown.enter)="onEnterPrecioUnitario($event)"
        />
        <div class="invalid-feedback d-block" *ngIf="precioUnitario.invalid && (precioUnitario.dirty || precioUnitario.touched)">
          El precio unitario es obligatorio y no puede ser negativo.
        </div>
      </div>

      <div class="mb-3">
        <label for="precioComercial" class="form-label">Precio Comercial</label>
        <input
          type="number"
          class="form-control"
          id="precioComercial"
          name="precioComercial"
          required
          min="0"
          [(ngModel)]="producto.precioComercial"
          #precioComercial="ngModel"
          #precioComercialInput
          (keydown.enter)="onEnterPrecioComercial($event)"
        />
        <div class="invalid-feedback d-block" *ngIf="precioComercial.invalid && (precioComercial.dirty || precioComercial.touched)">
          El precio comercial es obligatorio y no puede ser negativo.
        </div>
      </div>

      <div class="mb-3">
        <label for="categoria" class="form-label">Categoría</label>
        <select
          class="form-select"
          id="categoria"
          name="categoria"
          required
          [(ngModel)]="producto.categoria"
          #categoriaCtrl="ngModel"
          #categoriaSelect
          (keydown.enter)="onEnterCategoria($event, formulario)"
        >
          <option disabled [selected]="!producto.categoria">Selecciona una Categoría</option>
          <option *ngFor="let c of categorias" [value]="c.idCategoria">{{ c.nombreCategoria }}</option>
        </select>
        <div class="invalid-feedback d-block" *ngIf="categoriaCtrl.invalid && (categoriaCtrl.dirty || categoriaCtrl.touched)">
          Selecciona una categoría.
        </div>
      </div>

      <div class="confirmarfinal text-center mt-3">
        <button type="submit" data-bs-dismiss="offcanvas" class="btn confir" [disabled]="formulario.invalid || codigoExistente">Confirmar</button>
      </div>
    </form>
  </div>
</div>
